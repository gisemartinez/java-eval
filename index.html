<!DOCTYPE html>
<html lang="en" ng-app>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width, initial-scale=1">

		<title>Comerciales</title>

		<!-- Bootstrap -->
		<script   src="https://code.jquery.com/jquery-3.1.1.min.js"   integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="   crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-material-design/4.0.2/bootstrap-material-design.css">

		
		<script type="text/javascript">
			$( document ).ready(function() {
				let listadoDePedidosLabel = "Listado";
				let idPedidoLabel = "Id de Pedido";
				let montoPedidoLabel = "Monto $";
				let nombrePedidoLabel = "Nombre";
				let descuentoLabel = "Descuento $";
				var pedidosList = [];
				function Pedido(id,nombre, monto, desc) {
					this.id = id;
					this.nombre = nombre;
					this.monto = monto;
					this.descuento = desc;
				}
				$('#listadoDePedidosLabel')
					.text(listadoDePedidosLabel)
					.append(
					"<button id='agregarPedido' type='button' class='btn btn-default'><span class='glyphicon glyphicon-plus'></span></button>");
				$('#idPedidoLabel').text(idPedidoLabel);
				$('#nombrePedidoLabel').text(nombrePedidoLabel);
				$('#montoPedidoLabel').text(montoPedidoLabel);
				$('#descuentoPedidoLabel').text(descuentoLabel);
				$('#agregarPedido').click(
					function(ev){
						$('#modal').modal('show');
					});
				$('#submitPedido').click(
					function(ev){
						$('#alertPlace').html("");
						$('#alertPlace').css("visibility","hidden");
						let pedido = new Pedido(
								$('#idPedidoInput').val(),
								$('#nombrePedidoInput').val(),
								$('#montoPedidoInput').val(),
								$('#descuentoPedidoInput').val());
						if(estaVacio(pedido.nombre) || !esNombreValido(pedido.nombre)){
							(estaVacio(pedido.nombre))?
								fieldError("Nombre es un campo obligatorio"):
								fieldError("Nombre incorrecto, debe ser menor a 100 carácteres");
						}else if(estaVacio(pedido.monto) || !esEntero(pedido.monto)){
							(estaVacio(pedido.monto))?
							fieldError("Monto es un campo obligatorio"):
							fieldError("Monto incorrecto,debe ser un valor Integer");
						}else if(!estaVacio(pedido.descuento) && !esEntero(pedido.descuento)){
							fieldError("Descuento incorrecto,debe ser un valor Integer");			
						}else{
							$('#nombrePedidoInput').val(undefined);
							$('#montoPedidoInput').val(undefined);
							$('#descuentoPedidoInput').val(undefined);
							$('#modal').modal('hide');
							ajaxCreateOrUpdate(pedido);
						}
					});
				$('#cancelModal').click(
					function(ev){	
						$('#alertPlace').html("");
						$('#alertPlace').css("visibility","hidden");
						$('#idPedidoInput').val(undefined);
						$('#nombrePedidoInput').val(undefined);
						$('#montoPedidoInput').val(undefined);
						$('#descuentoPedidoInput').val(undefined);
						$('#modal').modal('hide');
					});
		
				function ajaxCreateOrUpdate(pedido){
					/*$.post(
						url,
						pedido,
						function(){
							//Seria mejor un nuevo pedido al server. 
							pedidosList.push(pedido);
							updateTable(pedidosList);
						}
					);*/
					//mockeado, para mostrar datos
					if(pedido.id == undefined || pedido.id == ""){
						pedido.id = Math.floor(Math.random()*100);
					} else {
						pedidosList.pop(pedido);
					}
					pedidosList.push(pedido);
					updateTable(pedidosList);
				}
				function updateTable(pedidos){
					$('tbody').html("<tr/>");
					$.each(pedidos, function(rowIndex, r) {
						var row = $("<tr>");
						$.each(r, function(colIndex, c) { 
							row.append($("<td/>").text(c));
						});
						row.append(
							function(){
								return $("<span class='glyphicon glyphicon-edit editar' aria-hidden='true' id='"+r.id+"'></span>").click(editHandler)
							});
						row.append(
							function(){
								return $("<span class='glyphicon glyphicon-remove eliminar' aria-hidden='true' id='"+r.id+"'></span>").click(eliminarHandler)
						});
						row.append("</tr");

						$('tbody').append(row);
					});	
				}
				function editHandler(event){
					var id = $(this).attr('id');
					
					var editable = pedidosList.find(
						function(elem){
							return parseInt(elem.id) == id;
						});
					if(editable !== undefined){
						$('#idPedidoInput').val(editable.id);
						$('#nombrePedidoInput').val(editable.nombre);
						$('#montoPedidoInput').val(editable.monto);
						$('#descuentoPedidoInput').val(editable.descuento);
						$('#modal').modal('show');
					}
				}
				function eliminarHandler(event){
					var id = $(this).attr('id');
					
					var editable = pedidosList.find(
						function(elem){
							return parseInt(elem.id) == id;
						});

					pedidosList.pop(editable);
					updateTable(pedidosList);
				}
				function esNombreValido(value){
					return value.length <= 100;
				}
				function esEntero(value){
					return !value.match(/\D/);
				}
				function estaVacio(value){
					return (value === undefined || value === "")
				}
				function fieldError(message){
					$('#alertPlace').append(message);
					$('#alertPlace').css("visibility","visible");
				}
			});
		</script>
		<style type="text/css">
			.editar {
				top:7px;
			    margin-left: 20px;
			}
			.eliminar {
				top: 7px;
			}
			#agregarPedido {
				margin-left: 4px
			}
		</style>
	</head>
	<body>
		<div class="page-header">
		  <h1>Navent<small>	Administrar Pedidos</small></h1>
		</div>
	<div class="container">
		<div class="row"></div>
		<div class="row">
			<div class="panel panel-default">
				<div class="panel-heading" id="listadoDePedidosLabel">
				</div>
				<div class="panel-body"></div>

		<table class="table">
			<thead>
				<tr>
					<th id="idPedidoLabel"></th>
					<th id="nombrePedidoLabel"></th>
					<th id="montoPedidoLabel"></th>
					<th id="descuentoPedidoLabel"></th>
					<th>Acción</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
		</table>
		
		</div>
			
	</div>

	<div id="modal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
					<h4 class="modal-title">Cargar Pedido</h4>
					<div id='alertPlace' class='alert alert-danger' role='alert' style="visibility: hidden;"><span class='glyphicon glyphicon-exclamation-sign' aria-hidden='true'></span><span class='sr-only'>Error:</span><span id="message"></span></div>
				</div>
				<div class="modal-body">
					<form>
						<div class="form-group">
							<input  type="hidden" class="form-control" id="idPedidoInput">
							<label for="nombrePedidoInput" id="nombrePedidoLabel"></label>
							<input  type="text" class="form-control" id="nombrePedidoInput" placeholder="Ingrese Nombre">
							<label for="montoPedidoInput" id="montoPedidoLabel"></label>
							<input  type="currency" class="form-control" id="montoPedidoInput" placeholder="Ingrese Monto">
							<label for="descuentoPedidoInput" id="descuentoPedidoLabel"></label>
							<input type="currency" class="form-control" id="descuentoPedidoInput" placeholder="Ingrese Descuento">
						</div>
					</form>


				</div>
				<div class="modal-footer">
					<button type="button" id="cancelModal" class="btn btn-default" data-dismiss="modal">Cerrar</button>
					<button type="submit" id="submitPedido" class="btn btn-primary">Enviar</button>
				</div>
			</div><!-- /.modal-content -->
		</div><!-- /.modal-dialog -->
	</div><!-- /.modal -->

  </body>
</html>